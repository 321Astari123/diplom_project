{% extends "base.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block extra_css %}
<style>
    .reader-controls {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        background-color: var(--primary-color);
        padding: 10px;
        z-index: 1000;
    }
    
    .page-content {
        margin-top: 60px;
        padding: 20px;
        font-size: 18px;
        line-height: 1.6;
    }
    
    .reader-nav {
        display: flex;
        align-items: center;
        gap: 15px;
    }
    
    .font-size-controls {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .font-size-btn {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
    }
    
    .page-nav {
        display: flex;
        gap: 10px;
    }
    
    .page-nav-btn {
        background: none;
        border: 1px solid white;
        color: white;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .page-nav-btn:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }
    
    .back-to-library {
        color: white;
        text-decoration: none;
        display: flex;
        align-items: center;
        gap: 5px;
    }
    
    .back-to-library:hover {
        color: rgba(255, 255, 255, 0.8);
    }
    
    .progress-indicator {
        color: white;
        font-size: 14px;
    }
</style>
{% endblock %}

{% block content %}
<div class="reader-controls">
    <div class="container d-flex justify-content-between align-items-center">
        <div class="reader-nav">
            <a href="{{ url_for('books.library') }}" class="back-to-library">
                <i class="fas fa-arrow-left"></i>
                <span>В библиотеку</span>
            </a>
            <div class="font-size-controls">
                <button class="font-size-btn" onclick="changeFontSize(-1)">
                    <i class="fas fa-font"></i> -
                </button>
                <button class="font-size-btn" onclick="changeFontSize(1)">
                    <i class="fas fa-font"></i> +
                </button>
            </div>
        </div>
        <div class="d-flex align-items-center gap-3">
            <div class="progress-indicator">
                Страница <span id="currentPage">1</span> из <span id="totalPages">{{ total_pages }}</span>
            </div>
            <div class="page-nav">
                <button class="page-nav-btn" onclick="prevPage()">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <button class="page-nav-btn" onclick="nextPage()">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <div class="page-content" id="pageContent">
        {{ content|safe }}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
let currentFontSize = 18;
let currentPage = 1;
const totalPages = Math.ceil(document.getElementById('pageContent').scrollHeight / window.innerHeight);

// Обновляем отображение общего количества страниц
document.getElementById('totalPages').textContent = totalPages;

function changeFontSize(delta) {
    currentFontSize = Math.max(12, Math.min(24, currentFontSize + delta));
    document.getElementById('pageContent').style.fontSize = `${currentFontSize}px`;
    localStorage.setItem('fontSize', currentFontSize);
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        scrollToPage();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        scrollToPage();
    }
}

function scrollToPage() {
    const pageHeight = window.innerHeight;
    window.scrollTo({
        top: (currentPage - 1) * pageHeight,
        behavior: 'smooth'
    });
    
    // Обновляем отображение текущей страницы
    document.getElementById('currentPage').textContent = currentPage;
    
    // Сохраняем прогресс
    const progress = (currentPage / totalPages) * 100;
    saveProgress(progress);
}

function saveProgress(progress) {
    fetch('{{ url_for("books.update_progress", book_id=book.id) }}', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
        },
        body: `progress=${progress}`
    })
    .then(response => response.json())
    .then(data => {
        if (!data.success) {
            console.error('Ошибка при сохранении прогресса');
        }
    })
    .catch(error => {
        console.error('Error:', error);
    });
}

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    // Восстанавливаем размер шрифта
    const savedFontSize = localStorage.getItem('fontSize');
    if (savedFontSize) {
        currentFontSize = parseInt(savedFontSize);
        document.getElementById('pageContent').style.fontSize = `${currentFontSize}px`;
    }
    
    // Определяем текущую страницу при загрузке
    currentPage = Math.floor(window.scrollY / window.innerHeight) + 1;
    document.getElementById('currentPage').textContent = currentPage;
    
    // Сохраняем прогресс при прокрутке
    window.addEventListener('scroll', function() {
        const scrollPosition = window.scrollY + window.innerHeight;
        const documentHeight = document.documentElement.scrollHeight;
        const progress = (scrollPosition / documentHeight) * 100;
        saveProgress(progress);
        
        // Обновляем номер текущей страницы
        currentPage = Math.floor(window.scrollY / window.innerHeight) + 1;
        document.getElementById('currentPage').textContent = currentPage;
    });
});
</script>
{% endblock %}