{% extends "base.html" %}

{% block title %}{{ book.title }}{% endblock %}

{% block extra_css %}
<style>
    :root {
        --reader-bg: #f5ecd7;
        --reader-panel-bg: #f8f5e6;
        --reader-text: #3a2c1a;
        --reader-accent: #a67c52;
        --reader-shadow: 0 8px 32px rgba(166,124,82,0.13);
        --reader-radius: 32px;
        --reader-font: 'Georgia', 'Times New Roman', Times, serif;
        --reader-ui-font: 'Inter', 'Arial', sans-serif;
    }
    
    .reader-container {
        background: var(--reader-bg);
        color: var(--reader-text);
        font-family: var(--reader-font);
        padding: 2.5em 2em 2em 2em;
        border-radius: var(--reader-radius);
        box-shadow: var(--reader-shadow);
        max-width: 1200px;
        margin: 2em auto;
        min-height: 70vh;
        display: flex;
        flex-direction: row;
        gap: 2em;
    }
    
    .reader-book {
        flex: 1 1 0;
        column-count: 2;
        column-gap: 3em;
        font-size: 1.18em;
        line-height: 1.7;
        letter-spacing: 0.01em;
        text-align: justify;
        min-height: 60vh;
        background: transparent;
    }
    
    .reader-book h2, .reader-book h3, .reader-book h4 {
        color: var(--reader-accent);
        break-after: avoid;
    }
    
    .reader-panel {
        min-width: 260px;
        max-width: 320px;
        background: var(--reader-panel-bg);
        border-radius: 24px;
        box-shadow: 0 2px 12px rgba(166,124,82,0.10);
        padding: 1.5em 1.2em;
        display: flex;
        flex-direction: column;
        gap: 1.2em;
        font-family: var(--reader-ui-font);
    }
    
    .reader-panel label {
        font-weight: 600;
        margin-bottom: 0.3em;
    }
    
    .reader-panel input[type=range] {
        width: 100%;
    }
    
    .reader-panel .btn {
        width: 100%;
        margin-top: 0.5em;
    }
    
    .reader-progress {
        width: 100%;
        height: 8px;
        background: #e6d3b3;
        border-radius: 6px;
        margin-top: 2em;
        position: relative;
    }
    
    .reader-progress-bar {
        height: 100%;
        background: var(--reader-accent);
        border-radius: 6px;
        transition: width 0.3s;
    }
    
    @media (max-width: 900px) {
        .reader-container { flex-direction: column; padding: 1.2em 0.5em; }
        .reader-panel { max-width: 100%; min-width: 0; }
        .reader-book { column-count: 1; font-size: 1.05em; }
    }
    
    @media (max-width: 600px) {
        .reader-container { border-radius: 12px; }
    }
</style>
{% endblock %}

{% block content %}
<div class="reader-container">
  <div class="reader-book" id="readerBook">
    <h2>{{ book.title }}</h2>
    <h4>{{ book.author }}</h4>
    <div id="bookContent">{{ content|safe }}</div>
  </div>
  <aside class="reader-panel">
    <label for="fontSizeRange">Размер шрифта</label>
    <input type="range" min="16" max="32" value="20" id="fontSizeRange">
    <label for="lineHeightRange">Межстрочный интервал</label>
    <input type="range" min="1.2" max="2.2" step="0.05" value="1.7" id="lineHeightRange">
    <label>Фон</label>
    <div style="display: flex; gap: 0.5em;">
      <button class="btn btn-secondary" style="background:#f5ecd7;" onclick="setBg('#f5ecd7')">Бежевый</button>
      <button class="btn btn-secondary" style="background:#fff; color:#222;" onclick="setBg('#fff')">Белый</button>
      <button class="btn btn-secondary" style="background:#222; color:#fff;" onclick="setBg('#222')">Тёмный</button>
    </div>
    <label for="fontFamilySelect">Шрифт</label>
    <select id="fontFamilySelect" class="form-control">
      <option value="Georgia">Georgia</option>
      <option value="Times New Roman">Times New Roman</option>
      <option value="Arial">Arial</option>
      <option value="Verdana">Verdana</option>
      <option value="Kazimir, serif">Kazimir</option>
    </select>
    <div class="reader-progress">
      <div class="reader-progress-bar" id="progressBar" style="width: {{ (current_page / total_pages * 100) if total_pages else 0 }}%"></div>
    </div>
    <div style="margin-top:1em; font-size:0.95em; color:#a67c52;">Страница {{ current_page }} из {{ total_pages }}</div>
  </aside>
</div>
<script>
const book = document.getElementById('readerBook');
const fontSizeRange = document.getElementById('fontSizeRange');
const lineHeightRange = document.getElementById('lineHeightRange');
const fontFamilySelect = document.getElementById('fontFamilySelect');
function setBg(color) {
  book.style.background = color;
  book.style.transition = 'background 0.3s';
}
fontSizeRange.addEventListener('input', e => {
  book.style.fontSize = e.target.value + 'px';
});
lineHeightRange.addEventListener('input', e => {
  book.style.lineHeight = e.target.value;
});
fontFamilySelect.addEventListener('change', e => {
  book.style.fontFamily = e.target.value;
});
</script>
{% endblock %}

{% block extra_js %}
<script>
const userId = {{ current_user.id }};
const bookId = {{ book.id }};
let currentFontSize = 18;
let totalPages = {{ total_pages }};
let currentPage = {{ current_page }};
let pageHeight = 0;
let isScrollingByButton = false;
let scrollTimeout = null;

// Обновляем отображение общего количества страниц
document.getElementById('totalPages').textContent = totalPages;
document.getElementById('currentPage').textContent = currentPage;
document.getElementById('fontSizeValue').textContent = currentFontSize;

// Функция для расчета высоты страницы
function calculatePageHeight() {
    const content = document.getElementById('pageContent');
    const navHeight = document.querySelector('.reader-controls').offsetHeight;
    const windowHeight = window.innerHeight;
    const contentHeight = content.scrollHeight;
    
    // Вычисляем реальную высоту страницы с учетом навигации
    pageHeight = windowHeight - navHeight;
    
    // Пересчитываем общее количество страниц
    totalPages = Math.ceil(contentHeight / pageHeight);
    document.getElementById('totalPages').textContent = totalPages;
    
    // Обновляем текущую страницу, если она вышла за пределы
    if (currentPage > totalPages) {
        currentPage = totalPages;
        document.getElementById('currentPage').textContent = currentPage;
    }
}

function scrollToPage() {
    if (!pageHeight) {
        calculatePageHeight();
    }
    const navHeight = document.querySelector('.reader-controls').offsetHeight;
    const scrollPosition = (currentPage - 1) * pageHeight;
    isScrollingByButton = true;
    window.scrollTo({
        top: scrollPosition,
        behavior: 'smooth'
    });
    document.getElementById('currentPage').textContent = currentPage;
    saveProgress((currentPage / totalPages) * 100);
    setTimeout(() => { isScrollingByButton = false; }, 500);
}

// Обновляем обработчик изменения размера окна
window.addEventListener('resize', function() {
    calculatePageHeight();
    scrollToPage();
});

// Обновляем обработчик прокрутки
window.addEventListener('scroll', function() {
    if (!pageHeight) {
        calculatePageHeight();
    }
    if (isScrollingByButton) return;
    clearTimeout(scrollTimeout);
    scrollTimeout = setTimeout(function() {
        const navHeight = document.querySelector('.reader-controls').offsetHeight;
        const scrollPosition = window.scrollY;
        const newPage = Math.floor(scrollPosition / pageHeight) + 1;
        if (newPage !== currentPage) {
            currentPage = newPage;
            document.getElementById('currentPage').textContent = currentPage;
            saveProgress((currentPage / totalPages) * 100);
        }
    }, 100);
});

// Обновляем функцию изменения размера шрифта
function changeFontSize(delta) {
    currentFontSize = Math.max(12, Math.min(24, currentFontSize + delta));
    document.getElementById('pageContent').style.fontSize = `${currentFontSize}px`;
    document.getElementById('fontSizeValue').textContent = currentFontSize;
    localStorage.setItem('fontSize', currentFontSize);
    
    // Пересчитываем высоту страницы после изменения шрифта
    setTimeout(calculatePageHeight, 100);
}

// Настройки темы
const themes = {
    light: {
        bg: '#ffffff',
        text: '#000000'
    },
    dark: {
        bg: '#1a1a1a',
        text: '#ffffff'
    },
    sepia: {
        bg: '#f4ecd8',
        text: '#000000'
    }
};

function toggleSettings() {
    const dropdown = document.getElementById('settingsDropdown');
    dropdown.classList.toggle('show');
}

function setTheme(theme) {
    const root = document.documentElement;
    const content = document.getElementById('pageContent');
    const body = document.body;
    
    // Обновляем тему сайта
    if (theme === 'dark') {
        body.setAttribute('data-theme', 'dark');
        content.style.backgroundColor = '#121212';
        content.style.color = '#ffffff';
    } else if (theme === 'sepia') {
        body.removeAttribute('data-theme');
        content.style.backgroundColor = '#f4ecd8';
        content.style.color = '#000000';
    } else {
        body.removeAttribute('data-theme');
        content.style.backgroundColor = '#ffffff';
        content.style.color = '#000000';
    }
    
    // Сохраняем настройки
    root.style.setProperty('--reader-bg', themes[theme].bg);
    root.style.setProperty('--reader-text', themes[theme].text);
    localStorage.setItem('readerTheme', theme);
    localStorage.setItem('theme', theme === 'dark' ? 'dark' : 'light');
}

function setFont(font) {
    document.documentElement.style.setProperty('--reader-font', font);
    localStorage.setItem('readerFont', font);
}

function prevPage() {
    if (currentPage > 1) {
        currentPage--;
        scrollToPage();
    }
}

function nextPage() {
    if (currentPage < totalPages) {
        currentPage++;
        scrollToPage();
    }
}

function saveProgress(progress) {
    if (typeof progress !== 'number' || isNaN(progress)) {
        console.error('Некорректное значение прогресса:', progress);
        return;
    }
    
    // Ограничиваем прогресс от 0 до 100
    progress = Math.max(0, Math.min(100, progress));
    
    fetch('{{ url_for("books.update_progress", book_id=book.id) }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
        body: `progress=${progress}`
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (!data.success) {
            console.error('Ошибка при сохранении прогресса:', data.error || 'Неизвестная ошибка');
        }
    })
    .catch(error => {
        console.error('Ошибка при сохранении прогресса:', error);
    });
}

// Функция для обработки изображений
function processImages() {
    const content = document.getElementById('pageContent');
    const images = content.getElementsByTagName('img');
    
    for (let img of images) {
        const src = img.getAttribute('src');
        if (src) {
            // Если путь относительный, добавляем базовый путь
            if (!src.startsWith('http') && !src.startsWith('/')) {
                img.src = '/static/uploads/books/' + src;
            }
            // Добавляем обработку ошибок загрузки изображений
            img.onerror = function() {
                this.style.display = 'none';
                console.warn('Не удалось загрузить изображение:', this.src);
            };
        }
    }
}

// Синхронизация темы сайта с темой читалки
function syncTheme() {
    const body = document.body;
    const isDark = body.getAttribute('data-theme') === 'dark';
    const content = document.getElementById('pageContent');
    
    if (isDark) {
        content.style.backgroundColor = '#121212';
        content.style.color = '#ffffff';
    } else {
        content.style.backgroundColor = '#ffffff';
        content.style.color = '#000000';
    }
}

// Делаем функцию доступной глобально для синхронизации
window.syncReaderTheme = syncTheme;

// Инициализация
document.addEventListener('DOMContentLoaded', function() {
    try {
        // Проверяем наличие необходимых элементов
        const pageContent = document.getElementById('pageContent');
        const currentPageElement = document.getElementById('currentPage');
        const totalPagesElement = document.getElementById('totalPages');
        const fontSizeValueElement = document.getElementById('fontSizeValue');
        
        if (!pageContent || !currentPageElement || !totalPagesElement || !fontSizeValueElement) {
            throw new Error('Не найдены необходимые элементы на странице');
        }
        
        // Восстанавливаем настройки
        const savedTheme = localStorage.getItem('readerTheme') || localStorage.getItem('theme') || 'light';
        const savedFont = localStorage.getItem('readerFont') || 'Arial';
        const savedFontSize = localStorage.getItem('fontSize');
        
        // Устанавливаем настройки
        setTheme(savedTheme);
        setFont(savedFont);
        if (savedFontSize) {
            currentFontSize = parseInt(savedFontSize);
            if (!isNaN(currentFontSize)) {
                pageContent.style.fontSize = `${currentFontSize}px`;
                fontSizeValueElement.textContent = currentFontSize;
            }
        }
        
        // Обновляем отображение текущей страницы
        currentPageElement.textContent = currentPage;
        
        // Вычисляем высоту страницы после загрузки контента
        setTimeout(calculatePageHeight, 100);
        
        // Прокручиваем к нужной странице после вычисления высоты
        setTimeout(scrollToPage, 200);
        
        // Обрабатываем изображения
        processImages();
        
        // Синхронизируем тему
        syncTheme();
        
        // Сохраняем прогресс при прокрутке
        let scrollTimeout;
        window.addEventListener('scroll', function() {
            // Используем debounce для оптимизации частых вызовов
            clearTimeout(scrollTimeout);
            scrollTimeout = setTimeout(function() {
                const scrollPosition = window.scrollY + window.innerHeight;
                const documentHeight = document.documentElement.scrollHeight;
                const progress = (scrollPosition / documentHeight) * 100;
                
                // Обновляем текущую страницу
                currentPage = Math.floor(window.scrollY / window.innerHeight) + 1;
                currentPageElement.textContent = currentPage;
                
                // Сохраняем прогресс и текущую страницу
                saveProgress(progress);
                localStorage.setItem('lastPage_' + bookId + '_user_' + userId, currentPage.toString());
            }, 100); // Задержка 100мс
        });
        
        // Закрываем выпадающее меню при клике вне него
        document.addEventListener('click', function(event) {
            const dropdown = document.getElementById('settingsDropdown');
            if (!event.target.closest('.reader-settings')) {
                dropdown.classList.remove('show');
            }
        });
    } catch (error) {
        console.error('Ошибка при инициализации читалки:', error);
        // Показываем сообщение об ошибке пользователю
        const errorMessage = document.createElement('div');
        errorMessage.style.cssText = 'position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:red;color:white;padding:20px;border-radius:5px;z-index:9999;';
        errorMessage.textContent = 'Произошла ошибка при загрузке читалки. Пожалуйста, обновите страницу.';
        document.body.appendChild(errorMessage);
    }
});

// Поиск по тексту
let searchResults = [];
let currentMatchIndex = -1;
let searchOptions = {
    caseSensitive: false,
    wholeWord: false,
    regex: false
};

function searchText() {
    const searchTerm = document.getElementById('searchInput').value;
    if (!searchTerm) {
        clearSearch();
        return;
    }
    // Ограничение длины поискового запроса
    if (searchTerm.length > 100) {
        alert('Слишком длинный поисковый запрос!');
        return;
    }
    const content = document.getElementById('pageContent');
    // Берём только видимый текст (текущую страницу)
    const navHeight = document.querySelector('.reader-controls').offsetHeight;
    const pageTop = window.scrollY;
    const pageBottom = pageTop + window.innerHeight - navHeight;
    let visibleText = '';
    for (const node of content.childNodes) {
        if (node.nodeType === Node.TEXT_NODE) {
            visibleText += node.textContent;
        } else if (node.nodeType === Node.ELEMENT_NODE) {
            const rect = node.getBoundingClientRect();
            const nodeTop = rect.top + window.scrollY;
            const nodeBottom = rect.bottom + window.scrollY;
            if (nodeBottom > pageTop && nodeTop < pageBottom) {
                visibleText += node.innerText || node.textContent;
            }
        }
    }
    let regex;
    try {
        if (searchOptions.regex) {
            regex = new RegExp(searchTerm, searchOptions.caseSensitive ? 'g' : 'gi');
        } else {
            const escapedTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
            const pattern = searchOptions.wholeWord ? `\\b${escapedTerm}\\b` : escapedTerm;
            regex = new RegExp(pattern, searchOptions.caseSensitive ? 'g' : 'gi');
        }
    } catch (e) {
        alert('Некорректное регулярное выражение!');
        return;
    }
    // Ищем только по видимому тексту
    const matches = [...visibleText.matchAll(regex)];
    searchResults = matches.map(match => ({
        index: match.index,
        length: match[0].length,
        text: match[0]
    }));
    highlightAllMatches();
    updateSearchUI();
}

function highlightAllMatches() {
    const content = document.getElementById('pageContent');
    const text = content.textContent;
    let html = text;
    
    // Подсвечиваем все совпадения
    for (let i = searchResults.length - 1; i >= 0; i--) {
        const match = searchResults[i];
        const before = html.substring(0, match.index);
        const matchText = html.substring(match.index, match.index + match.length);
        const after = html.substring(match.index + match.length);
        html = before + `<span class="search-match" data-index="${i}">${matchText}</span>` + after;
    }
    
    content.innerHTML = html;
    
    // Добавляем обработчики для подсветки при наведении
    const matches = content.getElementsByClassName('search-match');
    for (let match of matches) {
        match.addEventListener('mouseover', function() {
            this.classList.add('search-match-hover');
        });
        match.addEventListener('mouseout', function() {
            this.classList.remove('search-match-hover');
        });
    }
}

function updateSearchUI() {
    const searchNav = document.getElementById('searchNav');
    const matchCount = document.getElementById('matchCount');
    const prevBtn = document.getElementById('prevMatchBtn');
    const nextBtn = document.getElementById('nextMatchBtn');
    
    if (searchResults.length > 0) {
        searchNav.style.display = 'flex';
        matchCount.textContent = `${currentMatchIndex + 1}/${searchResults.length}`;
        prevBtn.disabled = currentMatchIndex <= 0;
        nextBtn.disabled = currentMatchIndex >= searchResults.length - 1;
        
        // Подсвечиваем текущее совпадение
        const matches = document.getElementsByClassName('search-match');
        for (let match of matches) {
            match.classList.remove('search-match-current');
        }
        if (currentMatchIndex >= 0) {
            matches[currentMatchIndex].classList.add('search-match-current');
            matches[currentMatchIndex].scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
    } else {
        searchNav.style.display = 'none';
    }
}

function clearSearch() {
    const content = document.getElementById('pageContent');
    content.innerHTML = content.textContent;
    searchResults = [];
    currentMatchIndex = -1;
    document.getElementById('searchNav').style.display = 'none';
}

function prevMatch() {
    if (currentMatchIndex > 0) {
        currentMatchIndex--;
        updateSearchUI();
    }
}

function nextMatch() {
    if (currentMatchIndex < searchResults.length - 1) {
        currentMatchIndex++;
        updateSearchUI();
    }
}

// Добавляем стили для подсветки
const style = document.createElement('style');
style.textContent = `
    .search-match {
        background-color: rgba(255, 255, 0, 0.3);
        cursor: pointer;
    }
    .search-match-hover {
        background-color: rgba(255, 255, 0, 0.5);
    }
    .search-match-current {
        background-color: rgba(255, 255, 0, 0.7);
    }
`;
document.head.appendChild(style);

// Добавляем обработчики поиска
document.getElementById('searchInput').addEventListener('input', searchText);

// Добавляем горячие клавиши для поиска
document.addEventListener('keydown', function(e) {
    if (e.ctrlKey && e.key === 'f') {
        e.preventDefault();
        document.getElementById('searchInput').focus();
    } else if (e.key === 'F3' || (e.ctrlKey && e.key === 'g')) {
        e.preventDefault();
        if (searchResults.length > 0) {
            nextMatch();
        }
    } else if (e.shiftKey && e.key === 'F3' || (e.ctrlKey && e.shiftKey && e.key === 'g')) {
        e.preventDefault();
        if (searchResults.length > 0) {
            prevMatch();
        }
    }
});

function toggleSearchOptions() {
    const options = document.getElementById('searchOptions');
    options.style.display = options.style.display === 'none' ? 'block' : 'none';
}

function updateSearchOptions() {
    searchOptions.caseSensitive = document.getElementById('caseSensitive').checked;
    searchOptions.wholeWord = document.getElementById('wholeWord').checked;
    searchOptions.regex = document.getElementById('useRegex').checked;
    
    // Перезапускаем поиск с новыми опциями
    searchText();
}

// Закрываем опции поиска при клике вне них
document.addEventListener('click', function(event) {
    const searchContainer = document.querySelector('.search-container');
    const searchOptions = document.getElementById('searchOptions');
    if (!searchContainer.contains(event.target)) {
        searchOptions.style.display = 'none';
    }
});
</script>
{% endblock %}